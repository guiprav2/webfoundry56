<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Webfoundry</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <style>
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
        box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.05);
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb {
        background-color: grey;
        border-radius: 4px;
        border: 2px solid transparent;
        background-clip: content-box;
      }
      ::-webkit-scrollbar-thumb:hover {
        background-color: #b0b0b0;
      }
      ::-webkit-scrollbar-thumb:horizontal {
        background-clip: padding-box;
      }
      ::-webkit-scrollbar-thumb:vertical {
        background-clip: padding-box;
      }
    </style>
  </head>
  <body class="min-h-screen">
    <script type="module">
      (async () => {
        window.rootPrefix = /^\/(files|preview)\//.test(location.pathname) ? location.pathname.split('/').slice(0, 4).join('/') : '/';
        if (rootPrefix === '/' || rootPrefix === '/collab.html') rootPrefix = '.';
        if (location.port) {
          await navigator.serviceWorker.register('/sw.js');
          await navigator.serviceWorker.ready;
          if (!navigator.serviceWorker.controller) return location.reload();
          let wforigin = `${location.protocol}//${location.hostname.split('.').slice(1).join('.')}`;
          let parts = location.pathname.slice(1).split('/');
          let tabId = parts[1];
          navigator.serviceWorker.addEventListener('message', async event => {
            let { type, project, path } = event.data || {};
            console.log(type, project, path);
            if (type !== 'fetch') return;
            let port = event.ports?.[0];
            if (!port) return;
            console.log('bridge fetch:', project, path);
            let handler = ev => {
              let data = ev.data || {};
              if (data.type !== 'fetch:res' || data.project !== project || data.path !== path) return;
              removeEventListener('message', handler);
              port.postMessage(data);
            };
            addEventListener('message', handler);
            parent.postMessage({ type: 'fetch', project, path }, wforigin);
          });
          let register = () => navigator.serviceWorker.controller.postMessage({ type:'webfoundry-register-tab', tabId });
          navigator.serviceWorker.addEventListener('controllerchange', register);
          register();
          let project = parts[2];
          let path = parts.slice(3).join('/');
          if (path !== 'index.html') {
            let handler = async ev => {
              let data = ev.data || {};
              if (data.type !== 'fetch:res' || data.project !== project || data.path !== path) return;
              removeEventListener('message', handler);
              document.open();
              document.write(await data.data.text());
              document.close();
              await import(`${rootPrefix}/webfoundry/ifdesigner.js`);
            };
            addEventListener('message', handler);
            parent.postMessage({ type: 'fetch', project, path }, wforigin);
            return;
          }
        }
        if (location.pathname.includes('/files/')) return;
        let [, md, mapp] = await Promise.all([
          import(`${rootPrefix}/webfoundry/head.js`),
          import(`${rootPrefix}/webfoundry/dominant.js`),
          import(`${rootPrefix}/webfoundry/app.js`),
        ]);
        document.body.append(md.default.el(mapp.default));
      })();
    </script>
  </body>
</html>
